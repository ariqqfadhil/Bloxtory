const CACHE_VERSION="bloxtory-v3",APP_SHELL_CACHE="bloxtory-v3-app-shell",DYNAMIC_CACHE="bloxtory-v3-dynamic",API_CACHE="bloxtory-v3-api",IMAGE_CACHE="bloxtory-v3-images",APP_SHELL_ASSETS=["/","/index.html","/app.bundle.js","/images/logo.png","/images/bloxtory_logo.png","/favicon.png","/manifest.json"],OFFLINE_IMAGE="/images/bloxtory_logo.png";async function cacheFirst(e,t){try{const o=await caches.open(t),n=await o.match(e);if(n)return n;const a=await fetch(e);return a&&a.ok&&o.put(e,a.clone()),a}catch(o){console.error("Cache First error:",o);const n=await caches.open(t);return await n.match(e)||new Response("Offline - Asset not available",{status:503,statusText:"Service Unavailable"})}}async function networkFirst(e,t){try{const o=await caches.open(t),n=await fetch(e);return n&&n.ok&&o.put(e,n.clone()),n}catch(o){console.log("Network First fallback to cache:",o);const n=await caches.open(t);return await n.match(e)||new Response(JSON.stringify({error:!0,message:"Offline - Data tidak tersedia"}),{status:503,headers:{"Content-Type":"application/json"}})}}async function networkFirstImages(e,t,o){try{const o=await fetch(e);if(o&&o.ok)return(await caches.open(t)).put(e,o.clone()),console.log("âœ… Image loaded from network:",e.url),o;throw new Error("Network response not ok")}catch(n){console.log("âš ï¸ Network failed, trying cache for:",e.url);const a=await caches.open(t),i=await a.match(e);return i?(console.log("âœ… Image loaded from cache (offline):",e.url),i):(console.log("âŒ No cache, using fallback image"),getFallbackImage(o))}}async function staleWhileRevalidate(e,t){try{const o=await caches.open(t),n=await o.match(e),a=fetch(e).then((t=>(t&&t.ok&&o.put(e,t.clone()),t))).catch((()=>n));return n||a}catch(e){return console.error("Stale While Revalidate error:",e),new Response("Error loading resource",{status:500})}}async function getFallbackImage(e){const t=await caches.open(APP_SHELL_CACHE);return await t.match(e)||new Response(new Blob([atob("iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==")],{type:"image/png"}),{status:200,statusText:"OK",headers:{"Content-Type":"image/png"}})}async function syncPendingStories(){try{const e=await openIndexedDB(),t=await getAllPendingStories(e);if(0===t.length)return void console.log("âœ… No pending stories to sync");console.log(`ğŸ”„ Syncing ${t.length} pending stories...`);for(const o of t)try{const t=await fetch(o.photo).then((e=>e.blob())),n=new FormData;n.append("description",o.description),n.append("photo",t,o.photoName),o.lat&&n.append("lat",o.lat),o.lon&&n.append("lon",o.lon);const a=await getAuthToken();if(!a){console.warn("No auth token available for sync");continue}const i=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${a}`},body:n});i.ok?(await deletePendingStory(e,o.tempId),console.log(`âœ… Story ${o.tempId} synced successfully`),await self.registration.showNotification("Story Synced",{body:"Your story has been synced to the server!",icon:"/images/bloxtory_logo.png",badge:"/images/bloxtory_logo.png"})):console.warn(`Failed to sync story ${o.tempId}:`,i.status)}catch(e){console.error(`âŒ Failed to sync story ${o.tempId}:`,e)}}catch(e){console.error("âŒ Background sync error:",e)}}function openIndexedDB(){return new Promise(((e,t)=>{const o=indexedDB.open("bloxtory-db",1);o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}))}function getAllPendingStories(e){return new Promise(((t,o)=>{const n=e.transaction(["pending-stories"],"readonly").objectStore("pending-stories").getAll();n.onsuccess=()=>t(n.result||[]),n.onerror=()=>o(n.error)}))}function deletePendingStory(e,t){return new Promise(((o,n)=>{const a=e.transaction(["pending-stories"],"readwrite").objectStore("pending-stories").delete(t);a.onsuccess=()=>o(),a.onerror=()=>n(a.error)}))}async function getAuthToken(){const e=await self.clients.matchAll();return e.length>0?(await new Promise((t=>{const o=new MessageChannel,n=setTimeout((()=>t({token:null})),1e3);o.port1.onmessage=e=>{clearTimeout(n),t(e.data)},e[0].postMessage({type:"GET_TOKEN"},[o.port2])}))).token:null}function showParsedNotification(e){let t={};try{t=JSON.parse(e)}catch{t={title:"Bloxtory Notification",body:e||"Ada cerita baru di Bloxtory!"}}return showNotification(t)}function showNotification(e){const t=e.title||"Bloxtory Notification",o={body:e.body||"Ada cerita baru di Bloxtory!",icon:e.icon||"/images/bloxtory_logo.png",badge:"/images/bloxtory_logo.png",data:{url:e.url||"#/home"},actions:[{action:"open_url",title:"Lihat Detail"}]};return self.registration.showNotification(t,o)}self.addEventListener("install",(e=>{console.log("Service Worker: Installing..."),e.waitUntil(caches.open(APP_SHELL_CACHE).then((e=>(console.log("Service Worker: Caching App Shell"),e.addAll(APP_SHELL_ASSETS).catch((e=>{console.error("Failed to cache:",e)})))))),self.skipWaiting()})),self.addEventListener("activate",(e=>{console.log("Service Worker: Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(!e.startsWith("bloxtory-v3")&&e.includes("bloxtory"))return console.log("Service Worker: Deleting old cache:",e),caches.delete(e)})))))),self.clients.claim()})),self.addEventListener("fetch",(e=>{const{request:t}=e,o=new URL(t.url);t.url.startsWith("http")&&"chrome-extension:"!==o.protocol&&"GET"===t.method&&(APP_SHELL_ASSETS.includes(o.pathname)||"style"===t.destination||"script"===t.destination?e.respondWith(cacheFirst(t,APP_SHELL_CACHE)):"story-api.dicoding.dev"!==o.hostname||"image"!==t.destination&&!o.pathname.includes("/images/")?"story-api.dicoding.dev"!==o.hostname||"image"===t.destination?"image"!==t.destination?e.respondWith(staleWhileRevalidate(t,DYNAMIC_CACHE)):e.respondWith(cacheFirst(t,DYNAMIC_CACHE)):e.respondWith(networkFirst(t,API_CACHE)):e.respondWith(networkFirstImages(t,IMAGE_CACHE,OFFLINE_IMAGE)))})),self.addEventListener("sync",(e=>{console.log("ğŸ”„ Background Sync Event:",e.tag),"sync-pending-stories"===e.tag&&e.waitUntil(syncPendingStories())})),self.addEventListener("push",(e=>{try{const t=e.data?e.data.text():"";return t instanceof Promise?void e.waitUntil(t.then((e=>showParsedNotification(e)))):e.waitUntil(showParsedNotification(t))}catch(t){console.error("Error membaca data push:",t);const o={title:"Bloxtory Notification",body:"Ada cerita baru di Bloxtory!"};e.waitUntil(showNotification(o))}})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=new URL(e.notification.data.url,self.location.origin).href;e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const o of e)if(o.url===t&&"focus"in o)return o.focus();if(clients.openWindow)return clients.openWindow(t)})))})),self.addEventListener("message",(e=>{e.data.type}));